# CLAUDE.md — Agent Operating Manual

This repo is designed for **multi-agent collaboration**. Multiple AI agents
may work on different parts of the codebase simultaneously. Follow these
rules to avoid conflicts and maintain consistency.

## Repo Map

```
/apps/web/          → Next.js frontend (TypeScript, Tailwind)
/apps/api/          → FastAPI backend (Python, SQLAlchemy, Alembic)
/packages/shared-types/ → Auto-generated TS types from OpenAPI
/packages/ui/       → Shared React components
/skills/            → Executable skill scripts for agents (read SKILLS_REGISTRY.md)
/rules/             → AI rule files for structured feature development (PRD workflow)
/tasks/             → Generated PRD.md and TASKS.md (gitignored per-feature work)
```

## Package Managers
- **JavaScript/TypeScript**: `pnpm` (never npm or yarn)
- **Python**: `uv` (never pip or poetry)

## Skills System
Before performing common operations, check `/skills/SKILLS_REGISTRY.md`.
Each skill has a `manifest.json` with trigger conditions, commands, and risk levels.
Execute skills via: `bash skills/<name>/run.sh [args]`

Key skills:
- `type-sync` — after changing Pydantic schemas
- `db-migrate` — after changing SQLAlchemy models
- `openapi-gen` — after changing API routes or schemas
- `dependency-add` — to add packages correctly
- `lint-fix` — before committing
- `test-run` — after completing work
- `prd-workflow` — **start here for new features** (PRD → tasks → execution)
- `deploy` — emergency manual deploy to Google Cloud Run (prefer CI/CD)

## PRD Workflow (Structured Feature Development)

Before writing any code for a new feature, use the 3-step PRD workflow:

```bash
bash skills/prd-workflow/run.sh init   # prints exact agent instructions
```

Then in your agent session, reference rule files in order:

1. **Define** — `@rules/generate_prd.md` + describe feature → produces `tasks/PRD.md`
2. **Plan**   — `@rules/generate_tasks.md @tasks/PRD.md`   → produces `tasks/TASKS.md`
3. **Build**  — `@rules/task_list_management.md @tasks/TASKS.md` → executes one task at a time

Rule files are in `/rules/`. Task files are written to `/tasks/` (not committed by default).
See `skills/prd-workflow/README.md` for the full rationale.

## Multi-Agent Coordination Rules

### 1. Ownership Boundaries
Agents MUST stay within their assigned scope. The codebase is divided into zones:

| Zone | Path | Primary Language |
|------|------|-----------------|
| Frontend | `apps/web/` | TypeScript |
| Backend | `apps/api/` | Python |
| Shared Types | `packages/shared-types/` | TypeScript |
| UI Library | `packages/ui/` | TypeScript |
| Skills | `skills/` | Bash + JSON |

### 2. File Locking Convention
Before modifying a file, check if another agent is working on it.
If you see a `// AGENT-LOCK: <agent-id>` comment at the top of a file,
do not modify it until the lock is removed.

### 3. Shared Resource Protocol
These files affect the entire repo. Modifications require extra care:
- `openapi.json` — regenerated by `type-sync` skill, do not edit manually
- `package.json` (root) — only modify via `pnpm add`
- `pyproject.toml` (root) — only modify for workspace config
- `turbo.json` — only modify to add/change task definitions

### 4. Type Contract
The Pydantic → OpenAPI → TypeScript pipeline is the contract between
backend and frontend. After any schema change:
1. Run `bash skills/type-sync/run.sh`
2. Do NOT manually edit `packages/shared-types/src/api-types.ts`

### 5. Commit Conventions
- Use conventional commits: `feat:`, `fix:`, `refactor:`, `docs:`, `chore:`
- Scope to the affected zone: `feat(api): add user endpoint`
- One logical change per commit

## Backend Patterns
- Config: `app.core.config.settings` (Pydantic Settings, reads `.env`)
- Logging: `from app.core.logging import get_logger` (never `print()`)
- DB sessions: `Depends(get_db)` in route handlers
- All endpoints need Pydantic request/response schemas

## Frontend Patterns
- Server Components by default, `"use client"` only when needed
- API types from `@repo/shared-types`, never local type definitions
- Shared components from `@repo/ui`

## CI/CD

### GitHub Actions Workflows
- `.github/workflows/ci.yml` — runs on every push/PR: lint, type-check, pytest, Next.js build. Path-filtered (only runs jobs for changed zones).
- `.github/workflows/deploy.yml` — runs on push to `main` only: builds Docker images → pushes to Artifact Registry → deploys to Cloud Run. Requires CI to pass (enforce via branch protection).
- `.github/workflows/pr.yml` — auto-labels PRs by changed path, runs Turbo affected build.

### Deployment (Google Cloud Run)
- API and Web are separate Cloud Run services.
- Auth uses **Workload Identity Federation** — no JSON keys stored anywhere.
- **Secrets** (DATABASE_URL, SECRET_KEY) live in GCP Secret Manager, injected at runtime via `--set-secrets`.
- **`NEXT_PUBLIC_API_URL`** is baked into the web Docker image at build time via `--build-arg` (Next.js bundles public vars at compile time, not at runtime).
- ChromaDB runs ephemerally on Cloud Run (`MEMORY_DB_PATH=/tmp/chromadb`). Data is not persisted across instances.

### Local Dev Entrypoint
```bash
make help          # all targets
make setup         # first-time: copies .env files, installs deps
make dev           # starts Docker stack + web dev server
make test          # run all tests
make lint          # lint and fix
make deploy-api    # emergency manual deploy (requires gcloud auth)
```

### One-time GCP Setup
See `skills/deploy/README.md` for the full WIF setup, IAM roles, Artifact Registry creation, and Secret Manager configuration.

## Memory & Context
- **ChromaDB**: Local vector database for agent memory (`app/services/memory.py`). No external API needed. Data stored in `.data/chromadb/`.
- **memory skill**: `bash skills/memory/run.sh save|recall|list` — agents must use this to persist decisions and recall context across sessions.
- **Entire CLI**: Context versioning — auto-captures agent checkpoints via hooks
- Agent memory files: `.claude/projects/*/memory/` persists across sessions

## Environment
- Copy `.env.example` → `.env` in `apps/api/` and `apps/web/` before running
- Never commit `.env` files
- All config via environment variables through Pydantic Settings
