# CLAUDE.md — Agent Operating Manual

This repo is designed for **multi-agent collaboration**. Multiple AI agents
may work on different parts of the codebase simultaneously. Follow these
rules to avoid conflicts and maintain consistency.

## Repo Map

```
/apps/web/          → Next.js frontend (TypeScript, Tailwind)
/apps/api/          → FastAPI backend (Python, SQLAlchemy, Alembic)
/packages/shared-types/ → Auto-generated TS types from OpenAPI
/packages/ui/       → Shared React components
/skills/            → Executable skill scripts for agents (read SKILLS_REGISTRY.md)
```

## Package Managers
- **JavaScript/TypeScript**: `pnpm` (never npm or yarn)
- **Python**: `uv` (never pip or poetry)

## Skills System
Before performing common operations, check `/skills/SKILLS_REGISTRY.md`.
Each skill has a `manifest.json` with trigger conditions, commands, and risk levels.
Execute skills via: `bash skills/<name>/run.sh [args]`

Key skills:
- `type-sync` — after changing Pydantic schemas
- `db-migrate` — after changing SQLAlchemy models
- `openapi-gen` — after changing API routes or schemas
- `dependency-add` — to add packages correctly
- `lint-fix` — before committing
- `test-run` — after completing work

## Multi-Agent Coordination Rules

### 1. Ownership Boundaries
Agents MUST stay within their assigned scope. The codebase is divided into zones:

| Zone | Path | Primary Language |
|------|------|-----------------|
| Frontend | `apps/web/` | TypeScript |
| Backend | `apps/api/` | Python |
| Shared Types | `packages/shared-types/` | TypeScript |
| UI Library | `packages/ui/` | TypeScript |
| Skills | `skills/` | Bash + JSON |

### 2. File Locking Convention
Before modifying a file, check if another agent is working on it.
If you see a `// AGENT-LOCK: <agent-id>` comment at the top of a file,
do not modify it until the lock is removed.

### 3. Shared Resource Protocol
These files affect the entire repo. Modifications require extra care:
- `openapi.json` — regenerated by `type-sync` skill, do not edit manually
- `package.json` (root) — only modify via `pnpm add`
- `pyproject.toml` (root) — only modify for workspace config
- `turbo.json` — only modify to add/change task definitions

### 4. Type Contract
The Pydantic → OpenAPI → TypeScript pipeline is the contract between
backend and frontend. After any schema change:
1. Run `bash skills/type-sync/run.sh`
2. Do NOT manually edit `packages/shared-types/src/api-types.ts`

### 5. Commit Conventions
- Use conventional commits: `feat:`, `fix:`, `refactor:`, `docs:`, `chore:`
- Scope to the affected zone: `feat(api): add user endpoint`
- One logical change per commit

## Backend Patterns
- Config: `app.core.config.settings` (Pydantic Settings, reads `.env`)
- Logging: `from app.core.logging import get_logger` (never `print()`)
- DB sessions: `Depends(get_db)` in route handlers
- All endpoints need Pydantic request/response schemas

## Frontend Patterns
- Server Components by default, `"use client"` only when needed
- API types from `@repo/shared-types`, never local type definitions
- Shared components from `@repo/ui`

## Memory & Context
- **Supermemory**: Long-term semantic memory for the AI backend (`app/services/memory.py`)
- **Entire CLI**: Context versioning — auto-captures agent checkpoints via hooks
- Agent memory files: `.claude/projects/*/memory/` persists across sessions

## Environment
- Copy `.env.example` → `.env` in `apps/api/` and `apps/web/` before running
- Never commit `.env` files
- All config via environment variables through Pydantic Settings
